# BarsBuild Auto-Deploy Workflow
# Automatically deploys to liron-yoga.barsbuild.me on every push

name: Deploy to BarsBuild

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          # Install singlefile plugin for inline build
          npm install vite-plugin-singlefile --save-dev

      - name: Build
        run: |
          # Create singlefile vite config
          cat > vite.config.singlefile.mjs << 'EOF'
          import { defineConfig } from 'vite';
          import react from '@vitejs/plugin-react';
          import { viteSingleFile } from 'vite-plugin-singlefile';
          export default defineConfig({
            plugins: [react(), viteSingleFile()],
            build: { cssCodeSplit: false, assetsInlineLimit: 100000000 }
          });
          EOF
          npx vite build --config vite.config.singlefile.mjs
          echo "Build size: $(wc -c < dist/index.html) bytes"

      - name: Deploy to BarsBuild
        env:
          BARSBUILD_TOKEN: "bb_e7c88bf2ed5d604db6882c9458e42bbf285097f5ea5944f203d38a24e632bd1f"
        run: |
          jq -n \
            --arg subdomain "liron-yoga" \
            --rawfile html dist/index.html \
            --arg title "$GITHUB_REPOSITORY" \
            --arg repoUrl "https://github.com/$GITHUB_REPOSITORY" \
            '{subdomain: $subdomain, html: $html, title: $title, repoUrl: $repoUrl}' > payload.json
          
          HTTP_CODE=$(curl -s --location-trusted -o response.txt -w "%{http_code}" \
            -X POST "https://barsbuild.me/api/deploy" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $BARSBUILD_TOKEN" \
            -d @payload.json)
          
          cat response.txt
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Deployed to https://liron-yoga.barsbuild.me"
          else
            echo "❌ Deploy failed with status $HTTP_CODE"
            exit 1
          fi

